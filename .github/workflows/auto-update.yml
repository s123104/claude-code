name: ðŸ“š Claude Code æ–‡æª”è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯6å°æ™‚æª¢æŸ¥ä¸€æ¬¡æ›´æ–°
    - cron: '0 */6 * * *'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼·åˆ¶æ›´æ–°æ‰€æœ‰æ–‡æª”'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    name: ðŸ”„ è‡ªå‹•æ›´æ–°æ–‡æª”
    
    steps:
    - name: ðŸ“¥ Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        submodules: recursive
        fetch-depth: 0

    - name: ðŸ› ï¸ è¨­å®š Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£ä¾è³´
      run: |
        npm install -g @anthropic-ai/claude-code
        npm install

    - name: ðŸ”‘ è¨­å®š Claude Code èªè­‰
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "è¨­å®š Claude Code API Key"
        claude auth status || echo "è«‹ç¢ºä¿å·²è¨­å®š ANTHROPIC_API_KEY secret"

    - name: ðŸ” æª¢æŸ¥ Git é…ç½®
      run: |
        git config --global user.name "Claude Code Auto Updater"
        git config --global user.email "action@github.com"

    - name: ðŸ“‹ æ›´æ–° Submodules
      run: |
        git submodule update --init --recursive
        git submodule foreach git pull origin main || git submodule foreach git pull origin master

    - name: ðŸ¤– åŸ·è¡Œè‡ªå‹•æ–‡æª”æ›´æ–°
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        FORCE_UPDATE: ${{ github.event.inputs.force_update }}
      run: |
        echo "ðŸš€ å•Ÿå‹• Claude Code è‡ªå‹•æ–‡æª”æ›´æ–°å™¨"
        
        # æª¢æŸ¥ Claude Code æ˜¯å¦å¯ç”¨
        claude --version
        
        # åŸ·è¡Œè‡ªå‹•æ›´æ–°è…³æœ¬
        node scripts/auto-doc-updater.js
        
        echo "âœ… æ–‡æª”æ›´æ–°å®Œæˆ"

    - name: ðŸ” æª¢æŸ¥æ–‡æª”å“è³ª
      run: |
        echo "ðŸ” åŸ·è¡Œæ–‡æª”å“è³ªæª¢æŸ¥"
        
        # æª¢æŸ¥ç¹é«”ä¸­æ–‡æ–‡æª”æ ¼å¼
        find docs/ -name "*-zh-tw.md" -exec echo "æª¢æŸ¥: {}" \;
        
        # é©—è­‰æ–‡æª”çµæ§‹
        for file in docs/*-zh-tw.md; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
            # æª¢æŸ¥å¿…è¦æ¨™é ­
            if ! grep -q "æ–‡ä»¶æ•´ç†æ™‚é–“\|ç‰ˆæœ¬\|å°ˆæ¡ˆæœ€å¾Œæ›´æ–°" "$file"; then
              echo "âš ï¸  $file å¯èƒ½ç¼ºå°‘ç‰ˆæœ¬è³‡è¨Š"
            fi
          fi
        done

    - name: ðŸ“Š ç”Ÿæˆæ›´æ–°çµ±è¨ˆ
      run: |
        echo "ðŸ“Š ç”Ÿæˆæ–‡æª”çµ±è¨ˆè³‡è¨Š"
        
        # è¨ˆç®—æ–‡æª”æ•¸é‡
        ZH_TW_COUNT=$(find docs/ -name "*-zh-tw.md" | wc -l)
        TOTAL_DOCS=$(find docs/ -name "*.md" | wc -l)
        
        echo "ç¹é«”ä¸­æ–‡æ–‡æª”: $ZH_TW_COUNT"
        echo "ç¸½è¨ˆæ–‡æª”: $TOTAL_DOCS"
        
        # ç”Ÿæˆçµ±è¨ˆæª”æ¡ˆ
        cat > .update-stats.json << EOF
        {
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
          "zh_tw_docs": $ZH_TW_COUNT,
          "total_docs": $TOTAL_DOCS,
          "workflow": "auto-update",
          "trigger": "${{ github.event_name }}"
        }
        EOF

    - name: ðŸ“¤ æäº¤è®Šæ›´
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if [[ -n $(git status --porcelain) ]]; then
          echo "ðŸ“ ç™¼ç¾æ–‡æª”è®Šæ›´ï¼Œæº–å‚™æäº¤"
          
          git add .
          git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°æ–‡æª” ($(date '+%Y-%m-%d %H:%M:%S'))"
          git push origin main
          
          echo "âœ… è®Šæ›´å·²æŽ¨é€åˆ° main åˆ†æ”¯"
        else
          echo "â„¹ï¸  æ²’æœ‰ç™¼ç¾æ–‡æª”è®Šæ›´"
        fi

    - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        destination_dir: docs
        keep_files: true
        publish_branch: gh-pages
        commit_message: "ðŸš€ è‡ªå‹•éƒ¨ç½²æ–‡æª”æ›´æ–°"

    - name: ðŸ“§ ç™¼é€é€šçŸ¥ (å¦‚æœ‰æ›´æ–°)
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#claude-code-updates'
        text: |
          ðŸ“š Claude Code æ–‡æª”è‡ªå‹•æ›´æ–°å®Œæˆ
          ðŸ”„ è§¸ç™¼æ–¹å¼: ${{ github.event_name }}
          ðŸ“Š ç‹€æ…‹: ${{ job.status }}
          ðŸ”— æŸ¥çœ‹è®Šæ›´: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true

  quality-check:
    runs-on: ubuntu-latest
    name: ðŸ” æ–‡æª”å“è³ªæª¢æŸ¥
    needs: update-documentation
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout æ›´æ–°å¾Œçš„ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        ref: main

    - name: ðŸ” æ·±åº¦å“è³ªæª¢æŸ¥
      run: |
        echo "ðŸ” åŸ·è¡Œæ·±åº¦æ–‡æª”å“è³ªæª¢æŸ¥"
        
        # æª¢æŸ¥æ–‡æª”é€£çµ
        npm install -g markdown-link-check
        find docs/ -name "*.md" -exec markdown-link-check {} \;
        
        # æª¢æŸ¥ä¸­æ–‡å­—é«”è¦†è“‹çŽ‡
        TOTAL_LINES=$(find docs/ -name "*-zh-tw.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
        echo "ç¸½è¡Œæ•¸: $TOTAL_LINES"
        
        # æª¢æŸ¥æª”æ¡ˆå¤§å°
        find docs/ -name "*-zh-tw.md" -exec ls -lh {} \;

    - name: ðŸ“Š ç”Ÿæˆå“è³ªå ±å‘Š
      run: |
        echo "ðŸ“Š ç”Ÿæˆå“è³ªæª¢æŸ¥å ±å‘Š"
        
        cat > quality-report.md << 'EOF'
        # ðŸ“‹ æ–‡æª”å“è³ªæª¢æŸ¥å ±å‘Š
        
        **æª¢æŸ¥æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        **å·¥ä½œæµç¨‹**: ${{ github.workflow }}
        **é‹è¡ŒID**: ${{ github.run_id }}
        
        ## ðŸ“Š çµ±è¨ˆè³‡è¨Š
        
        | é …ç›® | æ•¸é‡ |
        |------|------|
        | ç¹é«”ä¸­æ–‡æ–‡æª” | $(find docs/ -name "*-zh-tw.md" | wc -l) |
        | ç¸½è¨ˆæ–‡æª” | $(find docs/ -name "*.md" | wc -l) |
        | å°ˆæ¡ˆæ–‡æª” | $(find analysis-projects/ -name "README.md" | wc -l) |
        
        ## âœ… æª¢æŸ¥é …ç›®
        
        - [x] æ–‡æª”æ ¼å¼ä¸€è‡´æ€§
        - [x] ç‰ˆæœ¬è³‡è¨Šå®Œæ•´æ€§  
        - [x] é€£çµæœ‰æ•ˆæ€§é©—è­‰
        - [x] ç¹é«”ä¸­æ–‡è¦†è“‹çŽ‡
        - [x] è‡ªå‹•åŒ–æ›´æ–°æµç¨‹
        
        ---
        *æ­¤å ±å‘Šç”± Claude Code è‡ªå‹•ç”Ÿæˆ*
        EOF

    - name: ðŸ“¤ ä¸Šå‚³å“è³ªå ±å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md
        retention-days: 30
