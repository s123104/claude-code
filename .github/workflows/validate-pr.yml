name: ðŸ” PR é©—è­‰

on:
  pull_request:
    branches: [master, main]
    paths:
      - "docs/**"
      - "*.md"
      - "index.html"
      - "scripts/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: ðŸ“‹ æ–‡æª”é©—è­‰
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ” æª¢æŸ¥ Markdown æ ¼å¼
        run: |
          echo "## Markdown æ ¼å¼æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æœªé—œé–‰çš„ç¨‹å¼ç¢¼å€å¡Š
          error_count=0
          for file in $(find docs -name "*.md"); do
            count=$(grep -c "^\`\`\`" "$file" 2>/dev/null || echo "0")
            if [ $((count % 2)) -ne 0 ]; then
              echo "âŒ $file: ç¨‹å¼ç¢¼å€å¡Šæœªæ­£ç¢ºé—œé–‰" >> $GITHUB_STEP_SUMMARY
              error_count=$((error_count + 1))
            fi
          done
          
          if [ $error_count -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ–‡æª”æ ¼å¼æ­£ç¢º" >> $GITHUB_STEP_SUMMARY
          else
            echo "ç™¼ç¾ $error_count å€‹æ ¼å¼éŒ¯èª¤" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ðŸ“Š æª¢æŸ¥å…ƒè³‡æ–™
        run: |
          echo "## å…ƒè³‡æ–™æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          missing_count=0
          for file in docs/*-zh-tw.md; do
            if [ -f "$file" ]; then
              if ! grep -q "å°ˆæ¡ˆç‰ˆæœ¬" "$file"; then
                echo "âš ï¸ $(basename $file): ç¼ºå°‘å°ˆæ¡ˆç‰ˆæœ¬è³‡è¨Š" >> $GITHUB_STEP_SUMMARY
                missing_count=$((missing_count + 1))
              fi
              if ! grep -q "å°ˆæ¡ˆæœ€å¾Œæ›´æ–°" "$file"; then
                echo "âš ï¸ $(basename $file): ç¼ºå°‘å°ˆæ¡ˆæœ€å¾Œæ›´æ–°æ™‚é–“" >> $GITHUB_STEP_SUMMARY
                missing_count=$((missing_count + 1))
              fi
              if ! grep -q "æ–‡ä»¶æ•´ç†æ™‚é–“" "$file"; then
                echo "âš ï¸ $(basename $file): ç¼ºå°‘æ–‡ä»¶æ•´ç†æ™‚é–“" >> $GITHUB_STEP_SUMMARY
                missing_count=$((missing_count + 1))
              fi
            fi
          done
          
          if [ $missing_count -eq 0 ]; then
            echo "âœ… æ‰€æœ‰æ–‡æª”å…ƒè³‡æ–™å®Œæ•´" >> $GITHUB_STEP_SUMMARY
          else
            echo "ç™¼ç¾ $missing_count å€‹å…ƒè³‡æ–™ç¼ºå¤±" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ”— é©—è­‰å…§éƒ¨é€£çµ
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          folder-path: "docs/"
          config-file: ".github/markdown-link-check.json"
          use-quiet-mode: "yes"
        continue-on-error: true

  lint-scripts:
    name: ðŸ“ è…³æœ¬æª¢æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout ä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ðŸ” Shell è…³æœ¬èªžæ³•æª¢æŸ¥
        run: |
          echo "## Shell è…³æœ¬æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          error_count=0
          
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if bash -n "$script" 2>/dev/null; then
                echo "âœ… $(basename $script): èªžæ³•æ­£ç¢º" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ $(basename $script): èªžæ³•éŒ¯èª¤" >> $GITHUB_STEP_SUMMARY
                error_count=$((error_count + 1))
              fi
            fi
          done
          
          if [ $error_count -gt 0 ]; then
            exit 1
          fi

      - name: ðŸ” JavaScript èªžæ³•æª¢æŸ¥
        run: |
          echo "## JavaScript æª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          for script in scripts/*.js scripts/doc-sync/*.js scripts/doc-sync/*.cjs; do
            if [ -f "$script" ]; then
              if node --check "$script" 2>/dev/null; then
                echo "âœ… $(basename $script): èªžæ³•æ­£ç¢º" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ $(basename $script): èªžæ³•éŒ¯èª¤" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done
