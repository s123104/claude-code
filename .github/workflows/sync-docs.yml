name: ðŸ“š æ–‡æª”è‡ªå‹•åŒæ­¥

on:
  schedule:
    # æ¯æ—¥ UTC 18:00 (å°ç£æ™‚é–“ 02:00) åŸ·è¡Œ
    - cron: "0 18 * * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "å¼·åˆ¶åŒæ­¥æ‰€æœ‰å°ˆæ¡ˆ"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write

jobs:
  sync-projects:
    name: ðŸ”„ åŒæ­¥å°ˆæ¡ˆç‰ˆæœ¬
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: ðŸ“¥ Checkout ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: ðŸŸ¢ è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: npm ci

      - name: ðŸ”„ åŒæ­¥ analysis-projects
        run: |
          if [ -d "analysis-projects" ]; then
            cd analysis-projects
            for dir in */; do
              echo "Syncing $dir..."
              cd "$dir"
              git fetch origin 2>/dev/null || true
              default_branch=$(git remote show origin 2>/dev/null | grep 'HEAD branch' | awk '{print $NF}' || echo "main")
              git reset --hard "origin/$default_branch" 2>/dev/null || git reset --hard origin/master 2>/dev/null || true
              cd ..
            done
          else
            echo "âš ï¸ analysis-projects ç›®éŒ„ä¸å­˜åœ¨ï¼Œè·³éŽåŒæ­¥"
          fi

      - name: ðŸ“Š æ›´æ–°å°ˆæ¡ˆæ—¥æœŸ
        run: |
          if [ -d "analysis-projects" ]; then
            cd analysis-projects
            for dir in */; do
              project="${dir%/}"
              cd "$dir"
              last_date=$(git log -1 --format='%cd' --date=short 2>/dev/null || echo "")
              cd ..
              if [ -n "$last_date" ]; then
                echo "$project: $last_date"
              fi
            done
          else
            echo "âš ï¸ analysis-projects ç›®éŒ„ä¸å­˜åœ¨ï¼Œè·³éŽæ—¥æœŸæ›´æ–°"
          fi

      - name: ðŸ”„ åŒæ­¥ index.html
        run: |
          if [ -f "scripts/sync-index-docs.js" ]; then
            node scripts/sync-index-docs.js || echo "âš ï¸ sync-index-docs.js åŸ·è¡Œå¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œ"
          else
            echo "âš ï¸ scripts/sync-index-docs.js ä¸å­˜åœ¨ï¼Œè·³éŽ"
          fi

      - name: ðŸ“ æª¢æŸ¥è®Šæ›´
        id: check_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ æäº¤è®Šæ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "docs: è‡ªå‹•åŒæ­¥å°ˆæ¡ˆæ–‡æª” $(date +%Y-%m-%d)"
          git push

  validate-docs:
    name: ðŸ” é©—è­‰æ–‡æª”å“è³ª
    runs-on: ubuntu-latest
    needs: sync-projects
    if: always()

    steps:
      - name: ðŸ“¥ Checkout ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: ðŸ” é©—è­‰ Markdown é€£çµ
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          folder-path: "docs/"
          config-file: ".github/markdown-link-check.json"
          use-quiet-mode: "yes"
        continue-on-error: true

      - name: ðŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š
        run: |
          echo "## æ–‡æª”é©—è­‰å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- é©—è­‰æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- æ–‡æª”æ•¸é‡: $(find docs -name '*.md' | wc -l)" >> $GITHUB_STEP_SUMMARY
