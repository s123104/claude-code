#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Claude Code æ–‡æª”å°ˆæ¡ˆ Pre-commit Hook
# åœ¨æäº¤å‰è‡ªå‹•åŸ·è¡Œå“è³ªæª¢æŸ¥

echo "ğŸ” åŸ·è¡Œ Pre-commit æª¢æŸ¥..."

# æª¢æŸ¥ Markdown æ ¼å¼
echo "ğŸ“ æª¢æŸ¥ Markdown æ ¼å¼..."
error_count=0

for file in $(git diff --cached --name-only --diff-filter=ACM | grep '\.md$'); do
    if [ -f "$file" ]; then
        # æª¢æŸ¥ç¨‹å¼ç¢¼å€å¡Šé…å°
        count=$(grep -c "^\`\`\`" "$file" 2>/dev/null || echo "0")
        if [ $((count % 2)) -ne 0 ]; then
            echo "âŒ $file: ç¨‹å¼ç¢¼å€å¡Šæœªæ­£ç¢ºé—œé–‰"
            error_count=$((error_count + 1))
        fi
    fi
done

if [ $error_count -gt 0 ]; then
    echo "âŒ ç™¼ç¾ $error_count å€‹æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä¿®æ­£å¾Œå†æäº¤"
    exit 1
fi

echo "âœ… Markdown æ ¼å¼æª¢æŸ¥é€šé"

# æª¢æŸ¥æ˜¯å¦æœ‰éå¤§çš„æª”æ¡ˆ
echo "ğŸ“¦ æª¢æŸ¥æª”æ¡ˆå¤§å°..."
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
        if [ "$size" -gt 5000000 ]; then
            echo "âš ï¸  è­¦å‘Š: $file æª”æ¡ˆéå¤§ ($(($size / 1024 / 1024))MB)"
        fi
    fi
done

echo "âœ… Pre-commit æª¢æŸ¥å®Œæˆ"
exit 0
