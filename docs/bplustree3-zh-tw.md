# BPlusTree3 ä¸­æ–‡å…¨è§£ï¼ˆç¹é«”ä¸­æ–‡ç‰ˆï¼‰

> **ç‰ˆæœ¬**: v3.0ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰

## æ¦‚è¿°

**BPlusTree3** æ˜¯ç”±è»Ÿé«”å·¥ç¨‹å¤§å¸« **Kent Beck** å¯¦é©—é–‹ç™¼çš„é«˜æ•ˆèƒ½ B+ Tree è³‡æ–™çµæ§‹å¯¦ä½œï¼Œå°ˆç‚ºæ¢ç´¢ **AI è¼”åŠ©ç·¨ç¨‹**å’Œ**æ¥µé™æ•ˆèƒ½å„ªåŒ–**è€Œè¨­è¨ˆã€‚æœ¬å°ˆæ¡ˆå±•ç¤ºäº†çµåˆå‚³çµ±è»Ÿé«”å·¥ç¨‹æ™ºæ…§èˆ‡ç¾ä»£ AI å·¥å…·ï¼ˆç‰¹åˆ¥æ˜¯ Claude Codeï¼‰é€²è¡Œç³»çµ±ç´šç¨‹å¼è¨­è¨ˆçš„å¯èƒ½æ€§ã€‚

### ğŸ¯ Kent Beck å¯¦é©—å‹•æ©Ÿ

Kent Beck é–‹ç™¼æ­¤å°ˆæ¡ˆçš„æ ¸å¿ƒç›®çš„ï¼š

1. **AI è¼”åŠ©ç·¨ç¨‹å¯¦é©—**ï¼šæ¢ç´¢å¦‚ä½•åˆ©ç”¨ Claude Code é€²è¡Œè¤‡é›œç³»çµ±ç´šç¨‹å¼è¨­è¨ˆ
2. **æ•ˆèƒ½å„ªåŒ–ç ”ç©¶**ï¼šåœ¨ Rust å’Œ Python å…©ç¨®èªè¨€ä¸­å¯¦ç¾åŒä¸€è³‡æ–™çµæ§‹ï¼Œæ¯”è¼ƒå…¶æ•ˆèƒ½ç‰¹æ€§
3. **æ•™å­¸ç¤ºç¯„**ï¼šæä¾›é«˜å“è³ªçš„åƒè€ƒå¯¦ä½œï¼Œå±•ç¤º B+ Tree çš„æœ€ä½³å¯¦è¸
4. **é–‹æºè²¢ç»**ï¼šç‚ºç¤¾ç¾¤æä¾›ç”Ÿç”¢ç´šå“è³ªçš„ B+ Tree å¯¦ä½œ

### ğŸ”¬ å¯¦é©—çµæœ

é€éèˆ‡ Claude Code çš„å”ä½œï¼ŒKent Beck é”æˆï¼š

- âœ… **é›™èªè¨€é«˜æ•ˆèƒ½å¯¦ä½œ**ï¼ˆRust + Pythonï¼‰
- âœ… **é¡¯è‘—çš„æ•ˆèƒ½æå‡**ï¼š
  - Rustï¼šç¯„åœæƒæå¿« 32-68%ï¼ˆ1.5-2.8x ååé‡ï¼‰
  - Rustï¼šGET æ“ä½œå¿« 23-68%
  - Rustï¼šæ’å…¥å¿« 2-22%
  - Pythonï¼šéƒ¨åˆ†ç¯„åœæƒæå¿« 2.5x
  - Pythonï¼šä¸­ç­‰ç¯„åœæŸ¥è©¢å¿« 1.4x
- âœ… **ç”Ÿç”¢ç´šç¨‹å¼ç¢¼å“è³ª**ï¼ˆå®Œæ•´æ¸¬è©¦ã€å„ªç§€æ–‡æª”ï¼‰
- âœ… **æŒçºŒæ”¹é€²**ï¼ˆé è¨­ capacity å„ªåŒ–ã€å°èˆªå„ªåŒ–ã€ç†±è·¯å¾‘å…§è¯ï¼‰

> **å°ˆæ¡ˆè³‡è¨Š**
>
> - **å°ˆæ¡ˆåç¨±**ï¼šBPlusTree3
> - **å°ˆæ¡ˆç‰ˆæœ¬**ï¼šv0.9.0
> - **å°ˆæ¡ˆæœ€å¾Œæ›´æ–°**ï¼š2025-09-12
> - **æ–‡ä»¶æ•´ç†æ™‚é–“**ï¼š2025-12-24T00:42:00+08:00
>
> **æ ¸å¿ƒå®šä½**
>
> - **åŠŸèƒ½**ï¼šKent Beck å¯¦é©—é–‹ç™¼çš„é«˜æ•ˆèƒ½ B+ Tree è³‡æ–™çµæ§‹ï¼ŒRust + Python é›™èªè¨€å¯¦ä½œï¼ŒAI è¼”åŠ©ç·¨ç¨‹æ¡ˆä¾‹
> - **å ´æ™¯**ï¼šAI è¼”åŠ©ç·¨ç¨‹å¯¦é©—ã€æ•ˆèƒ½å„ªåŒ–ç ”ç©¶ã€è³‡æ–™åº«ç´¢å¼•ã€æ•™å­¸ç¤ºç¯„
> - **å®¢ç¾¤**ï¼šAI è¼”åŠ©é–‹ç™¼ç ”ç©¶è€…ã€æ•ˆèƒ½å„ªåŒ–å·¥ç¨‹å¸«ã€è³‡æ–™åº«é–‹ç™¼è€…ã€è»Ÿé«”å·¥ç¨‹å­¸ç¿’è€…
>
> **è³‡æ–™ä¾†æº**
>
> - [KentBeck/BPlusTree3](https://github.com/KentBeck/BPlusTree3) å®˜æ–¹æ–‡ä»¶èˆ‡åŸå§‹ç¢¼
> - [B+ Tree å­¸è¡“è³‡æº](https://en.wikipedia.org/wiki/B%2B_tree)
> - [è³‡æ–™åº«ç³»çµ±å¯¦ä½œåƒè€ƒ](https://db-book.com/)
> - [Claude Code AI è¼”åŠ©ç·¨ç¨‹æ¡ˆä¾‹ç ”ç©¶](https://docs.anthropic.com/en/docs/claude-code)

---

## ç›®éŒ„

1. [å°ˆæ¡ˆç°¡ä»‹](#1-å°ˆæ¡ˆç°¡ä»‹)
2. [è¨­è¨ˆç†å¿µèˆ‡è³‡æ–™çµæ§‹](#2-è¨­è¨ˆç†å¿µèˆ‡è³‡æ–™çµæ§‹)
3. [å®‰è£èˆ‡å¿«é€Ÿé–‹å§‹](#3-å®‰è£èˆ‡å¿«é€Ÿé–‹å§‹)
4. [æ ¸å¿ƒ API èˆ‡ç”¨æ³•](#4-æ ¸å¿ƒ-api-èˆ‡ç”¨æ³•)
5. [ç¯„ä¾‹ç¨‹å¼ç¢¼](#5-ç¯„ä¾‹ç¨‹å¼ç¢¼)
6. [å¸¸è¦‹æ“ä½œèˆ‡é€²éšæŠ€å·§](#6-å¸¸è¦‹æ“ä½œèˆ‡é€²éšæŠ€å·§)
7. [æœ€ä½³å¯¦è¸èˆ‡æ•ˆèƒ½å»ºè­°](#7-æœ€ä½³å¯¦è¸èˆ‡æ•ˆèƒ½å»ºè­°)
8. [ç–‘é›£æ’è§£èˆ‡å¸¸è¦‹å•é¡Œ](#8-ç–‘é›£æ’è§£èˆ‡å¸¸è¦‹å•é¡Œ)
9. [ç¤¾ç¾¤è³‡æºèˆ‡å»¶ä¼¸é–±è®€](#9-ç¤¾ç¾¤è³‡æºèˆ‡å»¶ä¼¸é–±è®€)

---

## 1. å°ˆæ¡ˆç°¡ä»‹

BPlusTree3 æ˜¯ Kent Beck æ‰€è¨­è¨ˆçš„é«˜æ•ˆèƒ½ B+ Tree è³‡æ–™çµæ§‹å¯¦ä½œï¼Œå°ˆç‚ºé«˜æ•ˆèƒ½ç´¢å¼•ã€è³‡æ–™åº«ç³»çµ±å’Œæª”æ¡ˆå„²å­˜è€Œè¨­è¨ˆã€‚åœ¨ Claude Code ç”Ÿæ…‹ç³»çµ±ä¸­ï¼Œæ­¤å¯¦ä½œç‰¹åˆ¥é©ç”¨æ–¼å¤§å‹ç¨‹å¼ç¢¼åº«çš„å¿«é€Ÿæª¢ç´¢å’Œæ•ˆèƒ½å„ªåŒ–å ´æ™¯ã€‚

### 1.1 é›™èªè¨€å¯¦ä½œç‰¹è‰²

- **ğŸ¦€ Rust å¯¦ä½œ**ï¼šé›¶æˆæœ¬æŠ½è±¡ã€åŸºæ–¼ Arena çš„è¨˜æ†¶é«”ç®¡ç†
- **ğŸ Python å¯¦ä½œ**ï¼šèˆ‡ SortedDict ç«¶çˆ­ï¼Œé‡å°ç‰¹å®šä½¿ç”¨æ¡ˆä¾‹å„ªåŒ–
- **è·¨å¹³å°æ”¯æ´**ï¼šå®Œæ•´çš„ Rust å’Œ Python ç”Ÿæ…‹ç³»çµ±æ•´åˆ

### 1.2 æ•ˆèƒ½äº®é»

#### Rust å¯¦ä½œ

- **ç¯„åœæƒæå¿« 32-68%**ï¼šç›¸æ¯” std::BTreeMapï¼ˆ1.5-2.8x ååé‡ï¼‰
- **GET æ“ä½œå¿« 23-68%**ï¼šæ‰€æœ‰è³‡æ–™é›†è¦æ¨¡ä¸‹éƒ½æ›´å¿«
- **æ’å…¥å¿« 2-22%**ï¼šå„ªç§€çš„æ“´å±•æ€§
- **å®Œæ•´ Rust ç¯„åœèªæ³•æ”¯æ´**ï¼š`3..7`ã€`3..=7`ã€`5..`ã€`..5`ã€`..` ç­‰
- **é è¨­ capacity 128**ï¼šé‡å°æ•ˆèƒ½å„ªåŒ–çš„é è¨­é…ç½®
- **æ¬Šè¡¡**ï¼šåˆªé™¤æ“ä½œåœ¨å„ªåŒ–å ´æ™¯ä¸‹æ…¢ 34%ï¼ˆé«˜ capacity æ™‚æ›´æ˜é¡¯ï¼‰

#### Python å¯¦ä½œ

- **éƒ¨åˆ†ç¯„åœæƒæå¿« 2.5 å€**ï¼šç›¸æ¯” SortedDictï¼ˆ50 é …é™åˆ¶æ™‚æœ€ä½³ï¼‰
- **ä¸­ç­‰ç¯„åœæŸ¥è©¢å¿« 1.4 å€**ï¼šé‡å°ç‰¹å®šæŸ¥è©¢æ¨¡å¼å„ªåŒ–
- **å¤§è³‡æ–™é›†è¿­ä»£å¿« 1.1-1.4x**ï¼šå„ªç§€çš„æ“´å±•æ€§ï¼ˆ200K-500K é …ç›®ï¼‰
- **è‡ªå‹•å¯¦ä½œé¸æ“‡**ï¼šC Extensionï¼ˆ2-4x æ›´å¿«ï¼‰æˆ– Pure Python å¾Œå‚™

### 1.3 åœ¨ Claude Code ä¸­çš„æ‡‰ç”¨

- **ç¨‹å¼ç¢¼ç´¢å¼•**ï¼šç‚ºå¤§å‹å°ˆæ¡ˆå»ºç«‹å¿«é€Ÿæª¢ç´¢ç´¢å¼•
- **ä¾è³´åˆ†æ**ï¼šè¿½è¹¤å’ŒæŸ¥è©¢æ¨¡çµ„é–“çš„ä¾è³´é—œä¿‚
- **ç‰ˆæœ¬æ¯”è¼ƒ**ï¼šé«˜æ•ˆæ¯”è¼ƒä¸åŒç‰ˆæœ¬é–“çš„æª”æ¡ˆè®Šæ›´
- **èªç¾©æœå°‹**ï¼šæ”¯æ´åŸºæ–¼å…§å®¹çš„æ™ºèƒ½æœå°‹åŠŸèƒ½

### 1.4 æ•ˆèƒ½å„ªå‹¢

| æ“ä½œé¡å‹ | æ™‚é–“è¤‡é›œåº¦   | ç©ºé–“è¤‡é›œåº¦ | Rust æ•ˆèƒ½å„ªå‹¢  | Python æ•ˆèƒ½å„ªå‹¢ |
| -------- | ------------ | ---------- | -------------- | --------------- |
| æ’å…¥     | O(log n)     | O(1)       | å¿« 2-22%       | ç«¶çˆ­æ€§          |
| åˆªé™¤     | O(log n)     | O(1)       | æ…¢ 34%ï¼ˆæ¬Šè¡¡ï¼‰ | ç«¶çˆ­æ€§          |
| æŸ¥è©¢     | O(log n)     | O(1)       | å¿« 23-68%      | ç«¶çˆ­æ€§          |
| ç¯„åœæŸ¥è©¢ | O(log n + k) | O(k)       | å¿« 32-68%      | å¿« 1.4-2.5x     |

**æ•ˆèƒ½åŸºæº–æ¸¬è©¦çµæœ**ï¼ˆç›¸æ¯”æ¨™æº–å¯¦ç¾ï¼‰ï¼š

- **Rust vs std::BTreeMap**ï¼š
  - ç¯„åœæƒæï¼š32-68% æ›´å¿«ï¼ˆ1.5-2.8x ååé‡ï¼Œ67K-212K vs 44K-83K items/msï¼‰
  - GET æ“ä½œï¼š23-68% æ›´å¿«ï¼ˆæ‰€æœ‰è³‡æ–™é›†è¦æ¨¡ï¼‰
  - æ’å…¥ï¼š2-22% æ›´å¿«ï¼ˆå¤§å‹è³‡æ–™é›†å„ªå‹¢æ›´æ˜é¡¯ï¼‰
  - åˆªé™¤ï¼š34% æ›´æ…¢ï¼ˆå„ªåŒ–å ´æ™¯ï¼‰ï¼Œé«˜ capacity æ™‚ 1.7-10.5x æ›´æ…¢

- **Python vs SortedDict**ï¼š
  - éƒ¨åˆ†ç¯„åœæƒæï¼ˆ50 é …é™åˆ¶ï¼‰ï¼š2.5x æ›´å¿« â­
  - ä¸­ç­‰ç¯„åœæŸ¥è©¢ï¼š1.4x æ›´å¿«
  - å¤§è³‡æ–™é›†è¿­ä»£ï¼ˆ200K-500Kï¼‰ï¼š1.1-1.4x æ›´å¿«

- å®˜æ–¹å°ˆæ¡ˆï¼š[KentBeck/BPlusTree3](https://github.com/KentBeck/BPlusTree3)

---

## 2. è¨­è¨ˆç†å¿µèˆ‡è³‡æ–™çµæ§‹

- **B+ Tree** å±¬æ–¼è‡ªå¹³è¡¡å¤šè·¯æœå°‹æ¨¹ï¼Œæ‰€æœ‰è³‡æ–™çš†å„²å­˜æ–¼è‘‰ç¯€é»ï¼Œå…§éƒ¨ç¯€é»åƒ…ä½œç‚ºç´¢å¼•ã€‚
- æ”¯æ´é«˜æ•ˆæ’å…¥ã€åˆªé™¤ã€æŸ¥è©¢èˆ‡ç¯„åœæŸ¥è©¢ã€‚
- é©åˆå¤§é‡è³‡æ–™ã€ç£ç¢Ÿåˆ†é ã€è³‡æ–™åº«ç´¢å¼•ã€‚
- ç¯€é»åˆ†è£‚èˆ‡åˆä½µè‡ªå‹•ç¶­æŒå¹³è¡¡ã€‚
- è‘‰ç¯€é»ä»¥éˆçµä¸²æ¥ï¼Œä¾¿æ–¼é †åºæƒæã€‚

### 2.1 æœ€æ–°æ¶æ§‹æ”¹é€²ï¼ˆ2025-09-12ï¼‰

- **é è¨­ capacity å„ªåŒ–**ï¼šå¾ 16 å¢åŠ åˆ° 128ï¼Œç²å¾—æ›´å¥½çš„é è¨­æ•ˆèƒ½
- **å°èˆªå„ªåŒ–**ï¼šé›†ä¸­åŒ– `find_leaf_for_key`ï¼Œæ¸›å°‘é‡è¤‡æŸ¥æ‰¾
- **ç†±è·¯å¾‘å…§è¯**ï¼šé—œéµè·¯å¾‘å‡½æ•¸å…§è¯å„ªåŒ–ï¼ˆ`find_leaf_for_key_with_match`ï¼‰
- **GET æ“ä½œå„ªåŒ–**ï¼šä½¿ç”¨è‘‰ç¯€é»æœå°‹åŒ¹é…æ¨™èªŒé¿å…éµç›¸ç­‰æª¢æŸ¥
- **ç¯„åœæŸ¥è©¢å„ªåŒ–**ï¼šç§»é™¤æ­»ä»£ç¢¼ï¼ˆ`optimize_range_query`ã€`estimate_range_size`ï¼‰
- **å®¹é‡ä¸è®Šé‡å¼·åˆ¶**ï¼šåœ¨åˆä½µæ™‚å¼·åˆ¶åŸ·è¡Œå®¹é‡ä¸è®Šé‡
- **è¨˜æ†¶é«”ç®¡ç†å„ªåŒ–**ï¼šæ›´é«˜æ•ˆçš„è¨˜æ†¶é«”åˆ†é…å’Œå›æ”¶
- **ä»£ç¢¼æ¸…ç†**ï¼šç«‹å³åˆªé™¤æ­»ä»£ç¢¼ï¼Œä¿æŒä»£ç¢¼åº«æ•´æ½”

---

## 3. å®‰è£èˆ‡å¿«é€Ÿé–‹å§‹

### 3.1 å–å¾—åŸå§‹ç¢¼

```bash
git clone https://github.com/KentBeck/BPlusTree3.git
cd BPlusTree3
```

### 3.2 Rust å¯¦ä½œ

```bash
cd rust
cargo build --release
cargo test --features testing

# é‹è¡ŒåŸºæº–æ¸¬è©¦
cargo bench

# é‹è¡Œç‰¹å®šåŸºæº–æ¸¬è©¦ï¼ˆå¦‚åˆªé™¤æ“ä½œï¼‰
cargo bench --bench comparison deletion

# å¤§å‹åˆªé™¤åŸºæº–æ¸¬è©¦
cargo run --release --bin large_delete_benchmark
```

### 3.3 Python å¯¦ä½œ

```bash
cd python
pip install -e .
python -m pytest
```

---

## 4. æ ¸å¿ƒ API èˆ‡ç”¨æ³•

### 4.1 Rust API

```rust
use bplustree::BPlusTreeMap;

// å»ºç«‹æ¨¹ï¼ˆé è¨­ capacity 128ï¼Œé‡å°æ•ˆèƒ½å„ªåŒ–ï¼‰
let mut tree = BPlusTreeMap::new(128).unwrap();

// æ’å…¥è³‡æ–™
tree.insert(10, "A");
tree.insert(20, "B");
tree.insert(30, "C");

// æŸ¥è©¢
assert_eq!(tree.get(&20), Some(&"B"));
assert_eq!(tree.len(), 3);

// ç¯„åœæŸ¥è©¢ï¼ˆæ”¯æ´å®Œæ•´ Rust ç¯„åœèªæ³•ï¼‰
for (key, value) in tree.range(10..=30) {
    println!("{}: {}", key, value);
}

// ä¸åŒç¯„åœé¡å‹
let a: Vec<_> = tree.range(3..7).collect();        // æ’é™¤çµæŸ
let b: Vec<_> = tree.range(3..=7).collect();      // åŒ…å«çµæŸ
let c: Vec<_> = tree.range(5..).collect();        // é–‹æ”¾çµæŸ
let d: Vec<_> = tree.range(..5).collect();        // å¾é–‹å§‹
let e: Vec<_> = tree.range(..).collect();         // å®Œæ•´ç¯„åœ

// é †åºè¿­ä»£
for (key, value) in tree.items() {
    println!("{}: {}", key, value);
}
```

### 4.2 Python API

```python
from bplustree import BPlusTreeMap

# å»ºç«‹æ¨¹ï¼ˆcapacity 128 ç²å¾—æœ€ä½³æ•ˆèƒ½ï¼‰
tree = BPlusTreeMap(capacity=128)

# æ’å…¥è³‡æ–™ï¼ˆå­—å…¸å¼èªæ³•ï¼‰
tree[1] = "one"
tree[3] = "three"
tree[2] = "two"

# æŸ¥è©¢
print(tree[2])        # "two"
print(len(tree))      # 3
print(2 in tree)      # True

# ç¯„åœæŸ¥è©¢
for key, value in tree.range(1, 3):
    print(f"{key}: {value}")

# è¿­ä»£
for key, value in tree.items():
    print(f"{key}: {value}")

# æª¢æŸ¥å¯¦ä½œé¡å‹
from bplustree import get_implementation
print(get_implementation())  # "C extension" æˆ– "Pure Python"
```

### 4.3 ä¸»è¦æ“ä½œ

#### Rust API

- `insert(key, value)`ï¼šæ’å…¥éµå€¼å°
- `remove(key)`ï¼šåˆªé™¤æŒ‡å®šéµ
- `get(&key)`ï¼šæŸ¥è©¢å–®ä¸€éµå€¼ï¼ˆè¿”å› `Option<&V>`ï¼‰
- `get_mut(&key)`ï¼šç²å–å¯è®Šå¼•ç”¨
- `range(range)`ï¼šç¯„åœæŸ¥è©¢ï¼ˆæ”¯æ´å®Œæ•´ Rust ç¯„åœèªæ³•ï¼‰
- `items()`ï¼šé †åºè¿­ä»£æ‰€æœ‰é …ç›®
- `len()`ï¼šç²å–é …ç›®æ•¸é‡
- `is_empty()`ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºç©º

#### Python API

- `tree[key] = value` æˆ– `insert(key, value)`ï¼šæ’å…¥éµå€¼å°
- `del tree[key]` æˆ– `remove(key)`ï¼šåˆªé™¤æŒ‡å®šéµ
- `tree[key]` æˆ– `get(key)`ï¼šæŸ¥è©¢å–®ä¸€éµå€¼
- `range(start, end)`ï¼šç¯„åœæŸ¥è©¢
- `items()`ï¼šè¿­ä»£æ‰€æœ‰éµå€¼å°
- `len(tree)`ï¼šç²å–é …ç›®æ•¸é‡
- `key in tree`ï¼šæª¢æŸ¥éµæ˜¯å¦å­˜åœ¨

### 4.4 ç¯€é»çµæ§‹

- å…§éƒ¨ç¯€é»ï¼šåƒ…å„²å­˜ç´¢å¼•éµèˆ‡å­ç¯€é»æŒ‡æ¨™
- è‘‰ç¯€é»ï¼šå„²å­˜å¯¦éš›è³‡æ–™èˆ‡éˆçµæŒ‡æ¨™

---

## 5. ç¯„ä¾‹ç¨‹å¼ç¢¼

### 5.1 Rust å®Œæ•´ç¯„ä¾‹

```rust
use bplustree::BPlusTreeMap;

fn main() {
    // å»ºç«‹æ¨¹ï¼ˆé è¨­ capacity 128 é‡å°æ•ˆèƒ½å„ªåŒ–ï¼‰
    // æ ¹æ“šä½¿ç”¨æ¡ˆä¾‹èª¿æ•´ capacityï¼š
    // - å°å‹è³‡æ–™é›†ï¼ˆ<10Kï¼‰ï¼š64-128
    // - ä¸­å‹è³‡æ–™é›†ï¼ˆ10K-100Kï¼‰ï¼š128-256
    // - å¤§å‹è³‡æ–™é›†ï¼ˆ>100Kï¼‰ï¼š256-512
    let mut tree = BPlusTreeMap::new(128).unwrap();

    // æ’å…¥è³‡æ–™
    for i in 0..1000 {
        tree.insert(i, format!("value_{}", i));
    }

    // ç¯„åœæŸ¥è©¢ï¼ˆæ”¯æ´å¤šç¨®ç¯„åœèªæ³•ï¼‰
    let range: Vec<_> = tree.range(100..=200).collect();
    println!("Found {} items in range 100..=200", range.len());

    // æŸ¥è©¢æ¸¬è©¦
    let start = std::time::Instant::now();
    for i in 0..1000 {
        tree.get(&i);
    }
    let duration = start.elapsed();
    println!("1000 lookups took: {:?}", duration);

    // é †åºè¿­ä»£
    for (key, value) in tree.items() {
        // è™•ç†æ¯å€‹é …ç›®
    }
}
```

### 5.2 Python å®Œæ•´ç¯„ä¾‹

```python
from bplustree import BPlusTreeMap
import time

def main():
    # å»ºç«‹æ¨¹ï¼ˆcapacity 128 ç²å¾—æœ€ä½³æ•ˆèƒ½ï¼‰
    # åº«æœƒè‡ªå‹•é¸æ“‡æœ€ä½³å¯¦ä½œï¼ˆC Extension æˆ– Pure Pythonï¼‰
    tree = BPlusTreeMap(capacity=128)

    # æ’å…¥è³‡æ–™ï¼ˆå­—å…¸å¼èªæ³•ï¼‰
    for i in range(1000):
        tree[i] = f"value_{i}"

    # ç¯„åœæŸ¥è©¢
    range_items = list(tree.range(100, 200))
    print(f"Found {len(range_items)} items in range 100..200")

    # æŸ¥è©¢æ¸¬è©¦
    start_time = time.time()
    for i in range(1000):
        _ = tree[i]  # å­—å…¸å¼æŸ¥è©¢
    duration = time.time() - start_time
    print(f"1000 lookups took: {duration:.4f} seconds")

    # æª¢æŸ¥å¯¦ä½œé¡å‹
    from bplustree import get_implementation
    print(f"Using: {get_implementation()}")

    # é †åºè¿­ä»£
    for key, value in tree.items():
        # è™•ç†æ¯å€‹é …ç›®
        pass

if __name__ == "__main__":
    main()
```

---

## 6. å¸¸è¦‹æ“ä½œèˆ‡é€²éšæŠ€å·§

- ç¯„åœæŸ¥è©¢ï¼šåˆ©ç”¨è‘‰ç¯€é»éˆçµé«˜æ•ˆéæ­·å€é–“
- å¤§é‡è³‡æ–™æ‰¹æ¬¡æ’å…¥æ™‚ï¼Œå»ºè­°å…ˆæ’åºå†æ‰¹æ¬¡å¯«å…¥
- æ”¯æ´è‡ªè¨‚æ¯”è¼ƒå™¨ã€åºåˆ—åŒ–å„²å­˜ï¼ˆä¾å°ˆæ¡ˆèªè¨€ï¼‰
- å¯ç”¨æ–¼è³‡æ–™åº«ç´¢å¼•ã€å¿«å–ã€æª”æ¡ˆç³»çµ±ç›®éŒ„ç­‰

### 6.1 æ•ˆèƒ½å„ªåŒ–æŠ€å·§

#### Rust å„ªåŒ–

```rust
use bplustree::BPlusTreeMap;

// æ ¹æ“šè³‡æ–™é›†è¦æ¨¡é¸æ“‡é©ç•¶çš„ capacity
// å°å‹è³‡æ–™é›†ï¼ˆ<10Kï¼‰ï¼š64-128
// ä¸­å‹è³‡æ–™é›†ï¼ˆ10K-100Kï¼‰ï¼š128-256ï¼ˆæ¨è–¦ï¼‰
// å¤§å‹è³‡æ–™é›†ï¼ˆ>100Kï¼‰ï¼š256-512
let mut tree = BPlusTreeMap::new(128).unwrap();  // é è¨­ 128

// å°æ–¼å¤§å‹è³‡æ–™é›†ï¼Œä½¿ç”¨æ›´é«˜çš„ capacity
let mut large_tree = BPlusTreeMap::new(256).unwrap();

// æ³¨æ„ï¼šé«˜ capacityï¼ˆ1024+ï¼‰åœ¨åˆªé™¤å¯†é›†å·¥ä½œè² è¼‰ä¸‹æ•ˆèƒ½æœƒä¸‹é™
// å»ºè­°ï¼šåˆªé™¤æ“ä½œ <15% æ™‚ä½¿ç”¨é«˜ capacityï¼Œå¦å‰‡ä½¿ç”¨è¼ƒä½ capacity
```

#### Python å„ªåŒ–

```python
from bplustree import BPlusTreeMap

# ä½¿ç”¨è¼ƒé«˜çš„ capacity ç²å¾—æ›´å¥½æ•ˆèƒ½
# capacity 128 æ˜¯æ¨è–¦çš„é è¨­å€¼
tree = BPlusTreeMap(capacity=128)

# å°æ–¼å¤§å‹è³‡æ–™é›†ï¼Œè€ƒæ…®æ›´é«˜çš„ capacity
large_tree = BPlusTreeMap(capacity=256)

# æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ C Extensionï¼ˆæ›´å¿«ï¼‰
from bplustree import get_implementation
if get_implementation() == "C extension":
    print("Using optimized C extension")
else:
    print("Using Pure Python (consider installing C extension)")

# è¨˜æ†¶é«”å„ªåŒ–
import gc
gc.collect()  # æ‰‹å‹•åƒåœ¾å›æ”¶
```

---

## 7. æœ€ä½³å¯¦è¸èˆ‡æ•ˆèƒ½å»ºè­°

### 7.1 Claude Code æ•´åˆæœ€ä½³å¯¦è¸

#### ç¨‹å¼ç¢¼ç´¢å¼•å„ªåŒ–

```python
# Claude Code å°ˆæ¡ˆç´¢å¼•ç¯„ä¾‹
class CodebaseIndex:
    def __init__(self, order=128):
        self.file_index = BPlusTree(order)
        self.symbol_index = BPlusTree(order)
        self.dependency_index = BPlusTree(order)

    def index_project(self, project_path):
        """ç‚ºæ•´å€‹å°ˆæ¡ˆå»ºç«‹ç´¢å¼•"""
        for file_path in self.scan_files(project_path):
            self.index_file(file_path)

    def fast_search(self, pattern):
        """å¿«é€Ÿæœå°‹ç¨‹å¼ç¢¼ç¬¦è™Ÿ"""
        return self.symbol_index.range_search(pattern)
```

#### æ•ˆèƒ½èª¿å„ªç­–ç•¥

- **Capacity é¸æ“‡**ï¼ˆé—œéµé…ç½®ï¼‰ï¼š
  - å°å‹è³‡æ–™é›†ï¼ˆ<10K é …ç›®ï¼‰ï¼šcapacity 64-128
  - ä¸­å‹è³‡æ–™é›†ï¼ˆ10K-100K é …ç›®ï¼‰ï¼šcapacity 128-256ï¼ˆæ¨è–¦ï¼‰
  - å¤§å‹è³‡æ–™é›†ï¼ˆ>100K é …ç›®ï¼‰ï¼šcapacity 256-512
  - **æ³¨æ„**ï¼šé«˜ capacityï¼ˆ1024+ï¼‰åœ¨åˆªé™¤å¯†é›†å·¥ä½œè² è¼‰ä¸‹æ•ˆèƒ½æœƒé¡¯è‘—ä¸‹é™

- **ä½¿ç”¨å ´æ™¯å»ºè­°**ï¼š
  - **ç¯„åœæŸ¥è©¢å¯†é›†ï¼ˆ>20% ç¯„åœæƒæï¼‰**ï¼šâœ… æ¨è–¦ä½¿ç”¨
  - **è®€å–å¯†é›†ï¼ˆ>60% GET æ“ä½œï¼‰**ï¼šâœ… æ¨è–¦ä½¿ç”¨
  - **å¤§å‹è³‡æ–™é›†åˆ†æ**ï¼šâœ… æ¨è–¦ä½¿ç”¨
  - **åˆªé™¤å¯†é›†ï¼ˆ>15% åˆªé™¤æ“ä½œï¼‰**ï¼šâš ï¸ ä¸æ¨è–¦ï¼Œè€ƒæ…®ä½¿ç”¨æ¨™æº– BTreeMap
  - **å°å‹è³‡æ–™é›†ä¸”æœªçŸ¥å­˜å–æ¨¡å¼**ï¼šâš ï¸ æ¨™æº– BTreeMap å¯èƒ½æ›´é©åˆ

- **è¨˜æ†¶é«”ç®¡ç†**ï¼š
  ```python
  # Python å¯¦ä½œè‡ªå‹•é¸æ“‡æœ€ä½³å¯¦ä½œ
  # C Extensionï¼š2-4x æ›´å¿«ï¼Œè‡ªå‹•ä½¿ç”¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  # Pure Pythonï¼šå¾Œå‚™å¯¦ä½œï¼Œç„¡éœ€ç·¨è­¯
  ```

### 7.2 ä½µç™¼å­˜å–æœ€ä½³å¯¦è¸

#### è®€å¯«åˆ†é›¢

```python
class ConcurrentBPlusTree:
    def __init__(self, order=256):
        self.tree = BPlusTree(order)
        self.read_lock = ReadWriteLock()
        self.write_lock = ReadWriteLock()

    def concurrent_read(self, key):
        with self.read_lock.read():
            return self.tree.search(key)

    def concurrent_write(self, key, value):
        with self.write_lock.write():
            return self.tree.insert(key, value)
```

#### æ‰¹æ¬¡æ“ä½œå„ªåŒ–

- **æ‰¹æ¬¡æ’å…¥**ï¼šç´¯ç©å¤šå€‹æ“ä½œå¾Œä¸€æ¬¡æ€§åŸ·è¡Œ
- **é å…ˆæ’åº**ï¼šæ’å…¥å‰å°è³‡æ–™é€²è¡Œæ’åºï¼Œæ¸›å°‘æ¨¹é‡çµ„
- **åˆ†æ®µè™•ç†**ï¼šå¤§é‡è³‡æ–™åˆ†æ‰¹è™•ç†ï¼Œé¿å…è¨˜æ†¶é«”æº¢å‡º

### 7.3 æŒä¹…åŒ–èˆ‡å‚™ä»½ç­–ç•¥

#### Write-Ahead Logging (WAL)

```python
class PersistentBPlusTree:
    def __init__(self, data_file, wal_file):
        self.data_file = data_file
        self.wal = WriteAheadLog(wal_file)
        self.tree = self.load_from_disk()

    def safe_insert(self, key, value):
        # å…ˆå¯«å…¥ WAL
        self.wal.log_operation('INSERT', key, value)
        # å†åŸ·è¡Œå¯¦éš›æ“ä½œ
        result = self.tree.insert(key, value)
        # åŒæ­¥åˆ°ç£ç¢Ÿ
        self.sync_to_disk()
        return result
```

#### å¢é‡å‚™ä»½

- **å·®ç•°å‚™ä»½**ï¼šåªå‚™ä»½è®Šæ›´çš„ç¯€é»
- **æª¢æŸ¥é»æ©Ÿåˆ¶**ï¼šå®šæœŸå‰µå»ºå®Œæ•´å¿«ç…§
- **å£“ç¸®å„²å­˜**ï¼šä½¿ç”¨å£“ç¸®ç®—æ³•æ¸›å°‘å„²å­˜ç©ºé–“

### 7.4 ç›£æ§èˆ‡è¨ºæ–·

#### æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤

```python
class BTreePerformanceMonitor:
    def __init__(self):
        self.metrics = {
            'operation_count': 0,
            'average_depth': 0,
            'cache_hit_rate': 0,
            'rebalance_frequency': 0
        }

    def track_operation(self, operation_type, duration):
        self.metrics['operation_count'] += 1
        # æ›´æ–°å…¶ä»–æŒ‡æ¨™...
```

#### è¨ºæ–·å·¥å…·

- **æ¨¹çµæ§‹è¦–è¦ºåŒ–**ï¼šç”Ÿæˆæ¨¹çš„åœ–å½¢è¡¨ç¤º
- **ç†±é»åˆ†æ**ï¼šè­˜åˆ¥é »ç¹å­˜å–çš„ç¯€é»
- **ç¢ç‰‡åŒ–æª¢æ¸¬**ï¼šç›£æ§æ¨¹çš„å¹³è¡¡åº¦

### 7.5 Claude Code ç‰¹å®šå„ªåŒ–

#### èªç¾©æœå°‹æ•´åˆ

```python
def semantic_code_search(query, btree_index):
    """çµåˆ Claude Code çš„èªç¾©ç†è§£é€²è¡Œæœå°‹"""
    # ä½¿ç”¨ Claude åˆ†ææŸ¥è©¢æ„åœ–
    semantic_tokens = claude_analyze(query)

    # åœ¨ B+ Tree ä¸­å¿«é€Ÿå®šä½ç›¸é—œç¨‹å¼ç¢¼
    candidates = []
    for token in semantic_tokens:
        candidates.extend(btree_index.range_search(token))

    # ä½¿ç”¨ Claude é€²è¡Œçµæœæ’åº
    return claude_rank_results(candidates, query)
```

#### ç‰ˆæœ¬å·®ç•°è¿½è¹¤

```python
def track_code_changes(old_tree, new_tree):
    """é«˜æ•ˆè¿½è¹¤ç¨‹å¼ç¢¼è®Šæ›´"""
    changes = {
        'added': [],
        'modified': [],
        'deleted': []
    }

    # åˆ©ç”¨ B+ Tree çš„æ’åºç‰¹æ€§å¿«é€Ÿæ¯”è¼ƒ
    old_iter = old_tree.iterator()
    new_iter = new_tree.iterator()

    # é›™æŒ‡é‡æ¼”ç®—æ³•æ¯”è¼ƒå…©å€‹æ¨¹
    # ...å¯¦ä½œç´°ç¯€

    return changes
```

---

## 8. ç–‘é›£æ’è§£èˆ‡å¸¸è¦‹å•é¡Œ

- æ’å…¥/åˆªé™¤å¾ŒæŸ¥è©¢ç•°å¸¸ï¼šæª¢æŸ¥ç¯€é»åˆ†è£‚èˆ‡åˆä½µé‚è¼¯
- ç¯„åœæŸ¥è©¢çµæœä¸æ­£ç¢ºï¼šç¢ºèªè‘‰ç¯€é»éˆçµæ˜¯å¦æ­£ç¢º
- æ•ˆèƒ½ç“¶é ¸ï¼šèª¿æ•´éšæ•¸ã€å„ªåŒ–ç£ç¢Ÿ I/Oã€æª¢æŸ¥é–å®šæ©Ÿåˆ¶
- ç·¨è­¯/åŸ·è¡ŒéŒ¯èª¤ï¼šç¢ºèªç›¸ä¾å¥—ä»¶èˆ‡èªè¨€ç‰ˆæœ¬

### 8.1 å¸¸è¦‹æ•ˆèƒ½å•é¡Œ

#### è¨˜æ†¶é«”ä½¿ç”¨éé«˜

```python
# æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
import psutil
process = psutil.Process()
print(f"Memory usage: {process.memory_info().rss / 1024 / 1024:.2f} MB")

# å„ªåŒ–è¨˜æ†¶é«”é…ç½®
tree = BPlusTree(order=64)  # æ¸›å°‘ç¯€é»å¤§å°
tree.set_memory_limit(1024 * 1024 * 100)  # è¨­å®šè¨˜æ†¶é«”é™åˆ¶
```

#### æŸ¥è©¢æ•ˆèƒ½ä¸‹é™

```python
# æª¢æŸ¥æ¨¹çš„å¹³è¡¡åº¦
def check_balance(tree):
    depths = []
    for leaf in tree.leaves():
        depths.append(tree.depth(leaf))

    avg_depth = sum(depths) / len(depths)
    max_depth = max(depths)

    print(f"Average depth: {avg_depth:.2f}")
    print(f"Max depth: {max_depth}")
    print(f"Balance ratio: {avg_depth / max_depth:.2f}")
```

---

## 9. ç¤¾ç¾¤è³‡æºèˆ‡å»¶ä¼¸é–±è®€

- [B+ Tree ç¶­åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/B%2B%E6%A0%91)
- [KentBeck/BPlusTree3 GitHub](https://github.com/KentBeck/BPlusTree3)
- [è³‡æ–™åº«ç³»çµ±æ¦‚è«–ï¼ˆB+ Tree ç« ç¯€ï¼‰](https://www.db-book.com/)
- [B+ Tree è¦–è¦ºåŒ–å·¥å…·](https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html)

### 9.1 ç›¸é—œç ”ç©¶èˆ‡è«–æ–‡

- **B+ Tree æ•ˆèƒ½åˆ†æ**ï¼šå„ç¨®å¯¦ä½œæ–¹å¼çš„æ•ˆèƒ½æ¯”è¼ƒ
- **è¨˜æ†¶é«”ç®¡ç†ç­–ç•¥**ï¼šArena åˆ†é…å™¨çš„å„ªåŒ–æŠ€è¡“
- **ä½µç™¼æ§åˆ¶**ï¼šå¤šåŸ·è¡Œç·’ç’°å¢ƒä¸‹çš„ B+ Tree æ“ä½œ
- **æŒä¹…åŒ–æŠ€è¡“**ï¼šWAL å’Œæª¢æŸ¥é»æ©Ÿåˆ¶çš„å¯¦ä½œ

### 9.2 ç¤¾ç¾¤è²¢ç»

- **æ•ˆèƒ½åŸºæº–æ¸¬è©¦**ï¼šæŒçºŒçš„æ•ˆèƒ½æ”¹é€²å’Œå„ªåŒ–
- **æ–°åŠŸèƒ½é–‹ç™¼**ï¼šæ”¯æ´æ›´å¤šè³‡æ–™é¡å‹å’Œæ“ä½œ
- **æ–‡æª”æ”¹é€²**ï¼šæ›´è©³ç´°çš„ä½¿ç”¨æŒ‡å—å’Œç¯„ä¾‹
- **æ¸¬è©¦è¦†è“‹**ï¼šæé«˜ç¨‹å¼ç¢¼å“è³ªå’Œç©©å®šæ€§

---

---

> **æ³¨æ„**ï¼šæœ¬æ–‡ä»¶ç‚ºç¤¾ç¾¤æ•´ç†ç‰ˆæœ¬ï¼Œè©³ç´°å…§å®¹èˆ‡æœ€æ–°è³‡æºè«‹åƒé–± [å®˜æ–¹ GitHub](https://github.com/KentBeck/BPlusTree3) èˆ‡ç›¸é—œæ–‡æª”ã€‚
>
> **ç‰ˆæœ¬è³‡è¨Š**ï¼šBPlusTree3 v0.9.0 - é«˜æ•ˆèƒ½ B+ Tree è³‡æ–™çµæ§‹ï¼ˆRust + Pythonï¼‰  
> **æœ€å¾Œæ›´æ–°**ï¼š2025-11-24T05:20:00+08:00  
> **å°ˆæ¡ˆæ›´æ–°**ï¼š2025-09-12T06:35:34+00:00  
> **ä¸»è¦è®Šæ›´**ï¼šé è¨­ capacity 128ã€æ•ˆèƒ½å„ªåŒ–ï¼ˆç¯„åœæƒæå¿« 32-68%ã€GET å¿« 23-68%ï¼‰ã€æ¶æ§‹æ”¹é€²ï¼ˆå°èˆªå„ªåŒ–ã€ç†±è·¯å¾‘å…§è¯ï¼‰
